#!/usr/bin/env ruby

require 'thor'

class MirrorSvnGit < Thor
  default_task :mirror

  desc 'mirror LOCAL_DIR GIT_REMOTE', 'mirror branches from svn repo to a git repo'
  def mirror(local_dir, git_remote)
    Dir.chdir(local_dir) do
      `git svn fetch`

      push_svn_branches(git_remote)

      `git checkout master`
      `git merge remotes/trunk`
      `git push #{git_remote} master`
    end
  end

  no_commands do
    def push_svn_branches(git_remote)
      svn_branches = `git branch -a`.split("\n").select do |branch_name|
        is_svn_branch? branch_name
      end

      svn_branches.each do |branch|
        `git push #{git_remote} #{branch}`
      end
    end

    def is_svn_branch?(branch_name)
      branch_name =~ /remotes\/[a-zA-Z\_\-]+$/
    end
  end
end

MirrorSvnGit.start(ARGV)
